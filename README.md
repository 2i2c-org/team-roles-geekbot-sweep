# Team Roles Geekbot Sweep

A Slack/Geekbot App to sweep through our Tech Team and assign Team Roles

## Summary

This repository is a collection of Python code that tracks which members of 2i2c's Tech Team (as defined by membership of the `team-team` Slack team) are currently serving in our Team Roles (Meeting Facilitator and Support Steward), works out which team member is due to take over the role, and dynamically generate Geekbot standups in Slack to visibly and explicitly notify the given team member that they are due to take over the role.

### Useful Documentation

**API docs:**

- [Slack API](https://api.slack.com/methods)
- [Geekbot API](https://geekbot.com/developers/)

**Tutorials on Slack bot building in Python:**

- [How to Build Your First Slack Bot with Python](https://www.fullstackpython.com/blog/build-first-slack-bot-python.html)
- [Building a simple bot using Python in 10 minutes](https://github.com/slackapi/python-slack-sdk/tree/main/tutorial)

## Installation

Installing the dependencies requires [`poetry`](https://python-poetry.org/).
You can install the dependencies by running:

```bash
poetry install
```

## Team Roles JSON file structure

Which members of the Tech Team are serving (or have served) in a given role are stored in the `team-roles.json` file, which has the below structure.

We keep track of both a team members Slack display name and user ID.
This is because interacting with the APIs requires the user ID, but it is more human-readable to also have the names.

For the Support Steward, we track both the current and incoming team members as we have two people overlapping in this role.

We have an extra role here called `standup_manager`.
This is the team member who created `GEEKBOT_API_KEY` and will be added to all standups.
This is because Geekbot only provide personal API keys and they do not have permission to see any standups the owner is not a member of.
:fire: **If you are changing this role, you will need to recreate `GEEKBOT_API_KEY`.** :fire:

```json
{
    "standup_manager": {
      "name": "display_name",
      "id": "slack_id"
    },
    "meeting_facilitator": {
        "name": "display_name",
        "id": "slack_id"
    },
    "support_steward": {
        "incoming": {
            "name": "display_name",
            "id": "slack_id"
        },
        "current": {
            "name": "display_name",
            "id": "slack_id"
        }
    }
}
```

## Scripts

All scripts are written in Python and are located in the [`src`](src/) folder.

### `get_slack_team_members.py`

This script interacts with the Slack API to produce a dictionary of Slack users who are members of a given Slack team (formally called a "usergroup" in the API), and their IDs.
The script requires two environment variables to be set:

- `TEAM_NAME`: The name of the Slack team to list members of, e.g., `tech-team`
- `SLACK_BOT_TOKEN`: A bot user token for a Slack App installed into the workspace.
  The bot requires the `usergroups:read` and `users:read` permission scopes to operate.
  It does not need to be a member of any channels in the Slack workspace.

The script will generate a dictionary of members of `TEAM_NAME` where the keys are the users' display names, and the values are their associated user IDs.
The dictionary is ordered alphabetically by its keys.

**Command line usage:**

Running the following command will print the dictionary of team members' names and IDs to the console.

```bash
poetry run list-team-members
```

### `update_team_roles.py`

This script reads in [`team-roles.json`](#team-roles-json-file-structure) and the dictionary generated by [`get_slack_team_members.py`](#get_slack_team_memberspy) and generates the next team member to serve in a given role by iterating one place through the dictionary.
The updated team roles are written back to the `team-roles.json` file.
There are command line flags to determine which role is to be updated.

**Command line usage:**

To execute, run the following command:

```bash
poetry run update-team-role { meeting-facilitator | support-steward }
```

Help info:

```bash
usage: update-team-role [-h] {meeting-facilitator,support-steward} ...

Update our Team Roles by iterating through members of the Tech Team

positional arguments:
  {meeting-facilitator,support-steward}
                        Available commands
    meeting-facilitator
                        Update the Meeting Facilitator role
    support-steward     Update the Support Steward role

optional arguments:
  -h, --help            show this help message and exit
```

### `create_geekbot_standup.py`

This script reads in [`team-roles.json`](#team-roles-json-file-structure) after it has been modified by [`update_team_roles.py`](#update_team_rolespy) and generates a Geekbot standup to notify the incoming team member for their upcoming role.

The `MeetingFacilitatorStandup` broadcasts to the `team-updates` Slack channel, and the `SupportStewardStandup` broadcasts to the `support-freshdesk` channel.
The [Geekbot app](https://geekbot.com/) needs to be installed to the Slack workspace and invited to the channels to which it will broadcast.

The script requires the `GEEKBOT_API_KEY` environment variable to be set with a valid API key for communicating with Geekbot's API.
Command line options are provided to select which role a standup should be created for.

**Command line usage:**

To execute, run the following command:

```bash
poetry run create-standup { meeting-facilitator | support-steward }
```

Help info:

```bash
usage: create-standup [-h] {meeting-facilitator,support-steward} ...

Create Geekbot standup apps to manage the transition of Team Roles through the Tech Team

positional arguments:
  {meeting-facilitator,support-steward}
                        Available commands
    meeting-facilitator
                        Create a Geekbot standup to transition the Meeting Facilitator role
    support-steward     Create a Geekbot standup to transition the Support Steward role

optional arguments:
  -h, --help            show this help message and exit
```

### `set_current_roles.py`

This script is used to initialise the `team-roles.json` file with manual input.
It depends upon [`get_slack_team_members.py`](#get_slack_team_memberspy) to convert Slack display names into user IDs.

In addition to the two environment variables required by `get_slack_team_members.py`, this script also requires the following environment variables to be set:

- `CURRENT_MEETING_FACILITATOR`: The Slack display name of the team member currently serving in the Meeting Facilitator role
- `CURRENT_SUPPORT_STEWARD`: The Slack display name of the team member currently serving in the Support Steward role (i.e. for more than two weeks)
- `INCOMING_SUPPORT_STEWARD`: The Slack display name of the team member most recently taking up service in the Support Steward role (i.e. for less than two weeks)
- `STANDUP_MANAGER`: This is the Slack display name of the team member who created `GEEKBOT_API_KEY` and will be added to all standups.
  This role is required since Geekbot only offers personal API keys and the script won't be able to see any exisitng standups that the owner of the key is not a member of.
  :fire: **If you are changing this role, you will need to recreate `GEEKBOT_API_KEY`.** :fire:

This script is paired with the [`populate-current-roles` workflow](#populate-current-rolesyaml) to commit the updated `team-roles.json` file to the repo for future CI/CD runs of the bot.

**Command line usage:**

To execute this script, run:

```bash
poetry run populate-current-roles
```

## CI/CD workflows

All our CI/CD workflows are powered by [GitHub Actions](https://docs.github.com/en/actions) and the configuration is located in the [`.github/workflows`](.github/workflows/) folder.

### `populate-current-roles.yaml`

This workflow runs the [`set_current_roles.py` script](#set_current_rolespy) to generate an initial `team-roles.json` file and commit it to the repo for use in future GitHub Actions workflow runs.
It can be triggered manually and requires the environment variables required by `set_current_roles.py` and [`get_slack_team_members.py`](#get_slack_team_memberspy) to be provided as inputs.
Note that `SLACK_BOT_TOKEN` is provided via a GitHub Action Environment Secret.

### `create-standup-meeting-facilitator.yaml`

_TBA_
